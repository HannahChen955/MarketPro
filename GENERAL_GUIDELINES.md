# MarketPro 通用开发指南与问题解决指南

> **目的**: 为MarketPro项目建立统一的开发指南、问题诊断流程和质量保障机制

## 📋 指南概览

本指南涵盖以下模块：
- 🤖 [AI助手模块](#ai-assistant-module) - AI功能开发与调试
- 🧪 [测试与验证模块](#testing-module) - 功能测试与质量保证
- 🔧 [调试工具模块](#debug-tools-module) - 开发调试工具
- 📊 [监控与分析模块](#monitoring-module) - 性能监控与问题分析

---

## 🤖 AI助手模块 {#ai-assistant-module}

### 📌 模块概述
AI助手是MarketPro的核心功能，包含聊天接口、内容生成、数据分析等功能。

### 🔍 问题诊断流程

#### 1. 环境检查验证
- [ ] ✅ 后端服务正常运行 (http://localhost:9527)
- [ ] ✅ 前端服务正常运行 (http://localhost:5678)
- [ ] ✅ 数据库连接正常
- [ ] ✅ .env文件包含必要的AI API密钥
- [ ] ✅ 演示用户存在于数据库中

#### 2. API调用链路验证
- [ ] ✅ Frontend发送正确的`message`字段 (不是`prompt`)
- [ ] ✅ Backend正确接收请求参数
- [ ] ✅ 开发环境能够获取到用户ID (demo@marketpro.ai)
- [ ] ✅ AI服务调用正常 (QWEN API)
- [ ] ✅ 数据库日志记录成功 (ai_usage_logs表)

#### 3. UI渲染验证
- [ ] ✅ AI助手图标正常显示
- [ ] ✅ 聊天界面正常打开
- [ ] ✅ 消息发送无报错
- [ ] ✅ AI回复正常显示
- [ ] ✅ Markdown格式正确渲染 (`**文本**` 显示为 **文本**)
- [ ] ✅ 列表、加粗等格式正常

#### 4. 错误处理验证
- [ ] ✅ 网络错误时显示友好提示
- [ ] ✅ API限额错误时有明确说明
- [ ] ✅ 服务不可用时不会无限重试
- [ ] ✅ 错误消息对用户友好且有指导性

### 🛠️ 调试工具使用

#### AI助手调试面板
**位置**: 开发环境下，项目页面右下角显示红色边框调试工具

**功能**:
- 🧪 测试AI聊天API - 完整的API调用测试
- 🏥 测试健康检查 - 验证AI服务状态
- 📋 详细日志输出 - 显示请求/响应详情
- 🗑️ 清除日志 - 重置调试信息

**使用步骤**:
1. 访问 http://localhost:5678/projects
2. 查看右下角调试面板
3. 点击"测试AI聊天API"
4. 复制日志信息进行分析

### 📝 已知问题与解决方案

#### 问题类型1: API请求格式错误
**现象**: 后端返回 "body must have required property 'message'"
**原因**: 前端发送`prompt`字段，后端期望`message`字段
**解决**: 在AIAssistant.tsx中转换字段格式

#### 问题类型2: Markdown渲染失败
**现象**: AI回复显示原始markdown语法如`**文本**`
**原因**: 缺少react-markdown组件
**解决**: 安装并配置ReactMarkdown组件

#### 问题类型3: 认证错误
**现象**: 401 Unauthorized错误
**原因**: 开发环境缺少用户认证
**解决**: 实现开发环境演示用户机制

#### 问题类型4: 数据库外键约束
**现象**: `ai_usage_logs_user_id_fkey` 违反外键约束
**原因**: 使用不存在的用户ID记录日志
**解决**: 运行`npm run db:seed`创建演示用户

#### 问题类型5: API响应字段不匹配
**现象**: 组件显示"AI响应格式错误"，但后端API和调试工具都正常
**原因**: 前端组件期望的响应字段与API实际返回字段不一致
**诊断**: 创建调试工具对比成功调用与失败组件的差异
**解决**: 修正组件中的字段名称匹配API实际响应格式
**文件**: `/src/components/chat/AIAssistant.tsx` - 响应处理逻辑

### 🔧 开发最佳实践

1. **API设计一致性**: 确保前后端字段命名一致
2. **错误处理完整性**: 每个API调用都应有错误处理
3. **用户体验友好性**: 错误信息对用户友好且有指导性
4. **调试信息完整性**: 关键操作都应有详细日志
5. **测试覆盖完整性**: 端到端测试所有功能路径

---

## 🧪 测试与验证模块 {#testing-module}

### 📌 模块概述
建立系统性的测试流程，确保功能质量和用户体验。

### 🔄 测试流程

#### 1. 单元测试
- API端点功能测试
- 组件渲染测试
- 数据处理逻辑测试

#### 2. 集成测试
- 前后端API调用测试
- 数据库操作测试
- 第三方服务集成测试

#### 3. 端到端测试
- 用户完整操作流程
- 跨页面功能测试
- 错误场景处理测试

---

## 🔧 调试工具模块 {#debug-tools-module}

### 📌 模块概述
提供开发和调试过程中的工具支持。

### 🛠️ 可用调试工具

#### 1. AI助手调试工具
- **文件**: `src/debug/AIAssistantDebug.tsx`
- **功能**: API调用测试、错误诊断、日志分析
- **使用**: 开发环境自动加载

#### 2. API客户端调试
- **位置**: `src/lib/api.ts`
- **功能**: 请求/响应日志、错误处理
- **配置**: 开发环境启用详细日志

#### 3. 后端服务监控
- **端点**: `/api/ai/health`
- **功能**: 服务状态检查、性能监控
- **访问**: curl或浏览器直接访问

---

## 📊 监控与分析模块 {#monitoring-module}

### 📌 模块概述
实时监控系统状态，分析性能指标和用户行为。

### 📈 监控指标

#### 1. 系统性能
- API响应时间
- 数据库查询性能
- 内存使用情况
- 错误率统计

#### 2. 用户体验
- 页面加载时间
- 功能使用频率
- 错误发生频次
- 用户流失点分析

#### 3. AI服务质量
- AI响应质量
- Token使用统计
- 缓存命中率
- 服务可用性

---

## 🔄 持续改进流程

### 1. 问题识别
- 用户反馈收集
- 监控数据分析
- 开发团队发现

### 2. 问题分析
- 根因分析
- 影响范围评估
- 解决方案设计

### 3. 解决实施
- 修复代码实现
- 测试验证
- 部署上线

### 4. 效果验证
- 监控数据对比
- 用户反馈跟踪
- 持续优化改进

---

## 📚 相关文档

- 📋 [项目问题追踪](./PROJECT_ISSUES_TRACKER.md) - 具体问题记录和解决过程
- 🏗️ [项目架构文档](./README.md) - 整体架构和技术选型
- 🚀 [部署指南](./docs/deployment.md) - 部署和运维指南

---

## 🎯 使用建议

1. **遇到问题时**: 先查看本指南对应模块的诊断流程
2. **开发新功能**: 参考最佳实践部分的开发规范
3. **调试问题**: 使用相应的调试工具进行诊断
4. **记录问题**: 在PROJECT_ISSUES_TRACKER.md中记录新发现的问题

通过统一的指南管理，我们能够：
- 🎯 快速定位和解决问题
- 📈 提升开发效率和质量
- 🔄 建立可持续的改进机制
- 👥 促进团队知识共享